import{b as n,q as H,x as A,j as t,G as L,r as U}from"./app-D4LeRcz-.js";import{c as l,D as G,a as W}from"./TaskDrawer.module-DQtVVtaZ.js";import{R as X}from"./RichTextEditor-y390pysp.js";import{u as q}from"./useTaskDrawerStore-0hUAEfq9.js";import{u as V}from"./useTasksStore-C_f5uqqL.js";import{a as J}from"./useWebSockets-pbD01iCb.js";import{b as K}from"./datetime-1UxvXaeE.js";import{h as Q}from"./user-IyQLa11_.js";import Z from"./Comments-OUjH255p.js";import $ from"./LabelsDropdown-DESZTGUR.js";import ee from"./Timer-BG5Exbq8.js";import{P as m}from"./enums-C8PG_d5N.js";import{D as ie}from"./Drawer-BtIeIGkv.js";import{C as _}from"./Checkbox-CaaVdcyM.js";import{T as c}from"./Text-CzrlvvXy.js";import{B as te}from"./Breadcrumbs-CC_rLmIW.js";import{T as re}from"./TextInput-DRGNA9wl.js";import{S as f}from"./Select-BQGepa1f.js";import{N as C}from"./NumberInput-EWnAPIl4.js";import{M as oe}from"./MultiSelect-qYHmzHib.js";import"./file-D4aCAaTQ.js";import"./upper-first-sQkIoMXG.js";import"./use-resolved-styles-api-ClQ3aNa8.js";import"./use-disclosure-BUX4v9Ej.js";import"./ConfirmModal-C-Ih1xUs.js";import"./IconCircleX-4GUC5knc.js";import"./createReactComponent-DvqdhCGr.js";import"./Image-Ck8bvJk_.js";import"./Center-CCRWs1KI.js";import"./IconX-DmULki5g.js";import"./SimpleGrid-ZtMkFqSk.js";import"./get-sorted-breakpoints-BPN_P9jc.js";import"./get-base-value-JqT_q0U7.js";import"./pick-calendar-levels-props-B7T8wbbP.js";import"./use-uncontrolled-D4udaf1u.js";import"./AccordionChevron-EMLFa_4k.js";import"./clamp-DTmYCdls.js";import"./InputBase-UfetLwmU.js";import"./Input-DgDk-0wJ.js";import"./create-optional-context-DIHD1p9X.js";import"./Popover-DklDwA2e.js";import"./DirectionProvider-BfCW8nl5.js";import"./use-floating-auto-update-CkIo9cus.js";import"./use-computed-color-scheme-DIep1U8t.js";import"./Tooltip-D6COxl5A.js";import"./get-style-object-DUJZA7T_.js";import"./ColorSwatch-CG_Yzh_s.js";import"./ColorPicker-CYgcYNpL.js";import"./ActionIcon-wK1_jKv1.js";import"./route-D3oki3go.js";import"./_baseClone-BatMgSYk.js";import"./index-DSL0mJnk.js";import"./reorder-BXn-1BMH.js";import"./useTaskGroupsStore-dyf8zUKe.js";import"./Title-v-f79xZF.js";import"./Flex-CdQtan9q.js";import"./Stack-BGDn0Wqx.js";import"./Avatar-ChRrt1Be.js";import"./Label-B4Jc12RG.js";import"./Combobox-DnGWXCU-.js";import"./PillsInput-DfF2hQDi.js";import"./Pill-DFbPvVIq.js";import"./CheckIcon-D7wk-t0p.js";import"./IconPlus-IXpy1Ztd.js";import"./Divider-BzK0McTm.js";import"./get-auto-contrast-value-Da6zqqWm.js";import"./OptionsDropdown-CxPr4e2C.js";import"./ScrollArea-BtKPsKY9.js";function xi(){var v;const x=n.useRef(null),{edit:s,openEditTask:D,closeEditTask:w}=q(),{initTaskWebSocket:O}=J(),{findTask:k,updateTaskProperty:d,complete:E,deleteAttachment:F,uploadAttachments:N}=V(),{usersWithAccessToProject:p,taskGroups:P,labels:j,openedTask:T,currency:u,auth:{user:R}}=H().props;n.useEffect(()=>{T&&setTimeout(()=>D(T),50)},[]);const e=k(s.task.id),[r,y]=n.useState({group_id:"",assigned_to_user_id:"",name:"",description:"",pricing_type:m.HOURLY,estimation:0,fixed_price:0,due_on:"",hidden_from_clients:!1,billable:!0,subscribed_users:[],labels:[]});n.useEffect(()=>{if(s.opened)return O(e)},[s.opened]),n.useEffect(()=>{s.opened&&(y({group_id:(e==null?void 0:e.group_id)||"",assigned_to_user_id:(e==null?void 0:e.assigned_to_user_id)||"",name:(e==null?void 0:e.name)||"",description:(e==null?void 0:e.description)||"",pricing_type:(e==null?void 0:e.pricing_type)||m.HOURLY,estimation:(e==null?void 0:e.estimation)||0,fixed_price:e!=null&&e.fixed_price?e.fixed_price/100:0,due_on:e!=null&&e.due_on?A(e==null?void 0:e.due_on).toDate():"",hidden_from_clients:(e==null?void 0:e.hidden_from_clients)!==void 0?e.hidden_from_clients:!1,billable:(e==null?void 0:e.billable)!==void 0?e.billable:!0,subscribed_users:((e==null?void 0:e.subscribed_users)||[]).map(i=>i.id.toString()),labels:((e==null?void 0:e.labels)||[]).map(i=>i.id)}),setTimeout(()=>{var i;(i=x.current)==null||i.setContent((e==null?void 0:e.description)||"")},300))},[s.opened,e]);const o=(i,a)=>{y({...r,[i]:a});const I=["labels","subscribed_users"],Y=["name","description","fixed_price"];if(I.includes(i)){const M={labels:a.map(g=>j.find(h=>h.id===g)),subscribed_users:a.map(g=>p.find(h=>h.id.toString()===g))};d(e,i,a,M[i])}else Y.includes(i)||d(e,i,a)},b=i=>{r.name.length>0&&(i==="fixed_price"?d(e,i,r[i]*100):d(e,i,r[i]))},B=[{value:m.HOURLY,label:"Hourly"},{value:m.FIXED,label:"Fixed"}],S=r.pricing_type===m.FIXED,z=(u==null?void 0:u.symbol)||"";return t.jsx(ie,{opened:s.opened,onClose:w,title:t.jsxs(L,{ml:25,my:"sm",wrap:"nowrap",children:[t.jsx(_,{size:"md",radius:"xl",color:"green",checked:(e==null?void 0:e.completed_at)!==null,onChange:i=>E(e,i.currentTarget.checked),className:can("complete task")?l.checkbox:l.disabledCheckbox}),t.jsxs(c,{fz:U(27),fw:600,lh:1.2,td:(e==null?void 0:e.completed_at)!==null?"line-through":null,children:["#",e==null?void 0:e.number,": ",r.name]})]}),position:"right",size:1e3,overlayProps:{backgroundOpacity:.55,blur:3},transitionProps:{transition:"slide-left",duration:400,timingFunction:"ease"},children:e?t.jsxs(t.Fragment,{children:[t.jsxs(te,{c:"dark.3",ml:24,mb:"xs",separator:"I",separatorMargin:"sm",styles:{separator:{opacity:.3}},children:[t.jsx(c,{size:"xs",children:e.project.name}),t.jsxs(c,{size:"xs",children:["Task #",e.number]}),t.jsxs(c,{size:"xs",children:["Created by ",e.created_by_user.name," on ",K(e.created_at)]})]}),t.jsxs("form",{className:l.inner,children:[t.jsxs("div",{className:l.content,children:[t.jsx(re,{label:"Name",placeholder:"Task name",value:r.name,onChange:i=>o("name",i.target.value),onBlur:()=>b("name"),error:r.name.length===0,readOnly:!can("edit task")}),t.jsx(X,{ref:x,mt:"xl",placeholder:"Task description",content:r.description,height:260,onChange:i=>o("description",i),onBlur:()=>b("description"),readOnly:!can("edit task")}),can("edit task")&&t.jsx(G,{mt:"xl",selected:e.attachments,onChange:i=>N(e,i),remove:i=>F(e,i)}),can("view comments")&&t.jsx(Z,{task:e})]}),t.jsxs("div",{className:l.sidebar,children:[t.jsx(f,{label:"Task group",placeholder:"Select task group",allowDeselect:!1,value:r.group_id.toString(),onChange:i=>o("group_id",i),data:P.map(i=>({value:i.id.toString(),label:i.name})),readOnly:!can("edit task")}),t.jsx(f,{label:"Assignee",placeholder:"Select assignee",searchable:!0,mt:"md",value:(v=r.assigned_to_user_id)==null?void 0:v.toString(),onChange:i=>o("assigned_to_user_id",i),data:p.map(i=>({value:i.id.toString(),label:i.name})),readOnly:!can("edit task")}),t.jsx(W,{clearable:!0,valueFormat:"DD MMM YYYY",minDate:new Date,mt:"md",label:"Due date",placeholder:"Pick task due date",value:r.due_on,onChange:i=>o("due_on",i),readOnly:!can("edit task")}),t.jsx($,{items:j,selected:r.labels,onChange:i=>o("labels",i),mt:"md"}),t.jsx(C,{label:"Time estimation",mt:"md",decimalScale:2,fixedDecimalScale:!0,value:r.estimation,min:0,allowNegative:!1,step:.5,suffix:" hours",onChange:i=>o("estimation",i),readOnly:!can("edit task")}),t.jsx(f,{label:"Pricing type",placeholder:"Select pricing type",mt:"md",value:r.pricing_type,onChange:i=>o("pricing_type",i),data:B,readOnly:!can("edit task")}),S&&(can("view time logs")||can("add time log"))&&t.jsx(C,{label:"Fixed price",mt:"md",decimalScale:2,fixedDecimalScale:!0,value:r.fixed_price,min:0,allowNegative:!1,onChange:i=>o("fixed_price",i),onBlur:()=>b("fixed_price"),prefix:z,readOnly:!can("edit task")}),!S&&(can("view time logs")||can("add time log"))&&t.jsx(ee,{mt:"xl",task:e}),t.jsx(_,{label:"Billable",mt:"xl",checked:r.billable,onChange:i=>o("billable",i.currentTarget.checked),disabled:!can("edit task")}),!Q(R,["client"])&&t.jsx(_,{label:"Hidden from clients",mt:"md",checked:r.hidden_from_clients,onChange:i=>o("hidden_from_clients",i.currentTarget.checked),disabled:!can("edit task")}),t.jsx(oe,{label:"Subscribers",placeholder:r.subscribed_users.length?null:"Select subscribers",mt:"lg",value:r.subscribed_users,onChange:i=>o("subscribed_users",i),data:p.map(i=>({value:i.id.toString(),label:i.name})),readOnly:!can("edit task")})]})]})]}):t.jsx(t.Fragment,{})})}export{xi as EditTaskDrawer};
