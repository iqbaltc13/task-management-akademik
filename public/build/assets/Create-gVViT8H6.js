import{q as z,b as c,k as f,l as E,j as e,G as P,B as y,r as g}from"./app-D4LeRcz-.js";import{A as R}from"./ActionButton-rmbJo8Uw.js";import{B as A}from"./BackButton-DFLoXhEp.js";import{u as D}from"./useForm-B7fipGN7.js";import{C as _}from"./ContainerBox-BAILQIgC.js";import{M as G}from"./MainLayout-c0lz6aJP.js";import{m as M}from"./currency-Ch0jvoq9.js";import{a as q}from"./route-D3oki3go.js";import H from"./Task-DshRsW2d.js";import{P as h}from"./enums-C8PG_d5N.js";import{B as L}from"./Breadcrumbs-CC_rLmIW.js";import{A as U}from"./Anchor-CBiFzQ8k.js";import{G as x}from"./Grid-BkmoyeoR.js";import{T as b}from"./Title-v-f79xZF.js";import{F as v}from"./Flex-CdQtan9q.js";import{T as O}from"./TextInput-DRGNA9wl.js";import{S as Y}from"./Select-BQGepa1f.js";import{M as V}from"./MultiSelect-qYHmzHib.js";import{C as X}from"./Checkbox-CaaVdcyM.js";import{N as C}from"./NumberInput-EWnAPIl4.js";import{T as J}from"./Textarea-BNXRMOxY.js";import{T as m}from"./Text-CzrlvvXy.js";import{S as K}from"./Stack-BGDn0Wqx.js";import{C as Q}from"./Center-CCRWs1KI.js";import{I as W}from"./IconSearch-B41ebevp.js";import"./createReactComponent-DvqdhCGr.js";import"./index-DsCOHdEJ.js";import"./FlashNotification-DeuRGHaA.js";import"./use-disclosure-BUX4v9Ej.js";import"./IconInfoCircle-DaNtb8XP.js";import"./IconCircleX-4GUC5knc.js";import"./useWebSockets-pbD01iCb.js";import"./index-DSL0mJnk.js";import"./useTaskGroupsStore-dyf8zUKe.js";import"./reorder-BXn-1BMH.js";import"./_baseClone-BatMgSYk.js";import"./useTasksStore-C_f5uqqL.js";import"./use-computed-color-scheme-DIep1U8t.js";import"./get-style-object-DUJZA7T_.js";import"./user-IyQLa11_.js";import"./Menu-G1kCLoC-.js";import"./use-resolved-styles-api-ClQ3aNa8.js";import"./Popover-DklDwA2e.js";import"./DirectionProvider-BfCW8nl5.js";import"./use-floating-auto-update-CkIo9cus.js";import"./use-uncontrolled-D4udaf1u.js";import"./Avatar-ChRrt1Be.js";import"./upper-first-sQkIoMXG.js";import"./IconLayoutList-CzD_g28R.js";import"./IconUsers-poB1dP6c.js";import"./ScrollArea-BtKPsKY9.js";import"./EmptyWithIcon-DPdwHi4J.js";import"./datetime-1UxvXaeE.js";import"./IconMessage-CQyKZKLL.js";import"./get-auto-contrast-value-Da6zqqWm.js";import"./ActionIcon-wK1_jKv1.js";import"./get-sorted-breakpoints-BPN_P9jc.js";import"./Label-B4Jc12RG.js";import"./ColorSwatch-CG_Yzh_s.js";import"./Pill-DFbPvVIq.js";import"./create-optional-context-DIHD1p9X.js";import"./Tooltip-D6COxl5A.js";import"./get-base-value-JqT_q0U7.js";import"./InputBase-UfetLwmU.js";import"./Input-DgDk-0wJ.js";import"./OptionsDropdown-CxPr4e2C.js";import"./CheckIcon-D7wk-t0p.js";import"./Combobox-DnGWXCU-.js";import"./PillsInput-DfF2hQDi.js";import"./clamp-DTmYCdls.js";const Z=()=>{const{projects:n,clientCompanies:j,nextNumber:k}=z().props,[p,S]=c.useState([]),[l,w]=c.useState(""),[d,T]=c.useState([]),[B,F]=c.useState(0),[t,I,a]=D("post",route("invoices.store"),{number:k,client_company_id:"",projects:[],tasks:[],type:"default",hourly_rate:0,fixed_amount:0,note:""});f(()=>{S(n.filter(o=>o.client_company_id==t.data.client_company_id).map(o=>({value:o.id.toString(),label:o.name})));const r=j.find(o=>t.data.client_company_id===o.id.toString());w(r.currency),a("projects",[])},[t.data.client_company_id]),f(()=>{t.data.projects.length&&E.get(route("invoices.tasks",{projectIds:t.data.projects})).then(({data:r})=>{T(r.projectTasks);const o=[];r.projectTasks.forEach(u=>{u.tasks.forEach(s=>{(s.pricing_type===h.HOURLY&&Number(s.total_minutes)>0||s.pricing_type===h.FIXED&&s.price>=0)&&o.push(s.id)})});const i=n.find(u=>t.data.projects[0]===u.id.toString());a({...t.data,tasks:[...o],hourly_rate:i?i.rate:0})}).catch(r=>console.error("Failed to fetch tasks",r))},[t.data.projects]),f(()=>{let r=0;t.data.type==="default"?d.forEach(o=>{o.tasks.forEach(i=>{t.data.tasks.includes(i.id)&&(i.pricing_type===h.HOURLY?r+=Number(i.total_minutes)/60*t.data.hourly_rate:r+=i.price)})}):r=t.data.fixed_amount,F(r)},[t.data.tasks,t.data.type,t.data.hourly_rate,t.data.fixed_amount]);const N=(r,o)=>{a("tasks",o?[...t.data.tasks,r]:t.data.tasks.filter(i=>i!==r))};return e.jsxs(e.Fragment,{children:[e.jsxs(L,{fz:14,mb:30,children:[e.jsx(U,{href:"#",onClick:()=>q("invoices.index"),fz:14,children:"Invoices"}),e.jsx("div",{children:"Create"})]}),e.jsxs(x,{justify:"space-between",align:"flex-end",gutter:"xl",mb:"lg",children:[e.jsx(x.Col,{span:"auto",children:e.jsx(b,{order:1,children:"Create invoice"})}),e.jsx(x.Col,{span:"content"})]}),e.jsxs(v,{gap:"xl",align:"flex-start",direction:"row",wrap:"nowrap",children:[e.jsx(_,{miw:"440",children:e.jsxs("form",{onSubmit:I,children:[e.jsx(O,{label:"Invoice number",placeholder:"Invoice number",required:!0,value:t.data.number,onChange:r=>a("number",r.target.value),error:t.errors.number}),e.jsx(Y,{label:"Client company",placeholder:"Select client company",searchable:!0,allowDeselect:!1,mt:"md",required:!0,value:t.data.client_company_id,onChange:r=>a("client_company_id",r),data:j.map(r=>({value:r.id.toString(),label:r.name})),error:t.errors.client_company_id}),e.jsx(V,{label:"Projects",placeholder:p.length?"Select projects":"Please select client company first",disabled:p.length===0,withAsterisk:!0,mt:"md",value:t.data.projects,onChange:r=>a("projects",r),data:p,error:t.errors.projects}),e.jsx(X,{label:"Fixed amount for whole invoice",mt:"md",checked:t.data.type==="fixed_amount",onChange:r=>a("type",r.currentTarget.checked?"fixed_amount":"default")}),t.data.type==="default"&&e.jsx(C,{label:"Hourly rate",mt:"md",allowNegative:!1,clampBehavior:"strict",decimalScale:2,fixedDecimalScale:!0,prefix:l.symbol,value:t.data.hourly_rate/100,onChange:r=>a("hourly_rate",r*100),error:t.errors.hourly_rate}),t.data.type==="fixed_amount"&&e.jsx(C,{label:"Fixed amount",mt:"md",allowNegative:!1,clampBehavior:"strict",decimalScale:2,fixedDecimalScale:!0,prefix:l.symbol,value:t.data.fixed_amount/100,onChange:r=>a("fixed_amount",r*100),error:t.errors.fixed_amount}),e.jsx(J,{label:"Note",placeholder:"Invoice note",mt:"md",autosize:!0,minRows:4,maxRows:8,value:t.data.note,onChange:r=>a("note",r.target.value)}),e.jsxs(P,{justify:"space-between",mt:30,children:[e.jsx(A,{route:"invoices.index"}),e.jsx(R,{loading:t.processing,children:"Create"})]})]})}),e.jsx(_,{style:{flexGrow:1},children:d.length>0?e.jsxs(e.Fragment,{children:[d.map(r=>e.jsxs(y,{mb:"lg",children:[e.jsx(b,{order:2,mb:"md",children:r.name}),r.tasks.length?r.tasks.map(o=>e.jsx(H,{task:o,selectedTasks:t.data.tasks,toggleTask:N,currency:l,type:t.data.type,hourlyRate:t.data.hourly_rate},o.id)):e.jsx(m,{size:"sm",c:"dimmed",children:"No tasks with logged time were found"})]},r.id)),e.jsx(v,{justify:"flex-end",mt:"xl",children:e.jsxs(K,{gap:0,children:[e.jsx(m,{size:"lg",lts:1,fw:600,mb:-5,children:"Total:"}),e.jsx(m,{fw:700,fz:32,children:M(B,l.code)})]})})]}):e.jsx(e.Fragment,{children:e.jsx(Q,{mih:300,children:e.jsxs(y,{align:"center",children:[e.jsx(W,{style:{width:g(55),height:g(55)},opacity:.5}),e.jsx(m,{fz:24,fw:600,align:"center",children:"No tasks found"}),e.jsx(m,{fz:15,c:"dimmed",children:"Select company and at least one project"})]})})})})]})]})};Z.layout=n=>e.jsx(G,{title:"Create invoice",children:n});export{Z as default};
